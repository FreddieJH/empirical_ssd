{
  "hash": "a572b172b3f251fe3b90374243aa3af3",
  "result": {
    "markdown": "---\ntitle: \"Universal body size\"\nauthor: \"Freddie Heather\"\neditor: visual\ndate: \"14 March, 2023\"\n\nexecute:\n  freeze: auto  # re-render only when source changes\n---\n\n\n\n\n## Background\n\n**Main question:** Is there a universal shape of species body size distributions?\n\nThe shape is determined by the probability of being a certain size. I.e. it is the probability distribution that we are interested in.\n\nThis can be re-framed by asking the question: Do all species have the same coefficient of variation in their distribution (i.e. sdlog in the lognormal distribution)?\n\n## Analysis\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse, quietly = TRUE)\nlibrary(lubridate, quietly = TRUE)\nlibrary(rstan, quietly = TRUE)\nlibrary(magick)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Observational-level data (body size, abundance, species, survey ID)\n# Only selecting non-targeted species\nobs_data <- \n  \"data/raw/obs_data_m1_aus.parquet\" |> \n  read_parquet() |> \n  filter(species_name %in% read_rds(\"output/data/selected_spp.rds\")) |> \n  filter(!(species_name == \"Neoodax balteatus\" & size_class == 150))\n\n# Survey-level information\nsurvey_list <- \n  \"data/cleaned/survey_list_m1_aus.parquet\" |> \n  read_parquet() \n\n\n# Reef Life Survey (RLS) size class bins\ncutoff <- c(\n  2.5, 5, 7.5, 10, 12.5, 15, 20, 25, 30, 35, 40, 50, \n  seq(from = 62.5, to = 200, by = 12.5), \n  seq(from = 250, to = 500, by = 50))\n\n\n# Body size bin upper and lower bounds\nrls_bins <- \n  tibble(\n    size_index = 0:length(cutoff),\n    size_class = c(0, cutoff),\n    bin_lwr = (size_class + lag(size_class))/2,\n    bin_upr = (size_class + lead(size_class))/2\n  ) |>\n  filter(size_index != 0)\n```\n:::\n\n\n### Single site\n\nLet's look at a single location, across all time, and see the distribution of body sizes.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# \"BI-S1\" is the site with most surveys\nselected_site <- \n  survey_list |> \n  add_count(site_code) |> \n  arrange(desc(n)) |> \n  head(1) |> \n  pull(site_code)\n\n\ndata_filter_site <- \n  obs_data |> \n  left_join(survey_list, by = join_by(survey_id)) |> \n  filter(site_code == selected_site) |> \n  count(species_name, size_class, name = \"n_indivs\") |> \n  add_count(species_name, \n            wt = n_indivs,\n            name = \"n_indivs_total\") |> \n  mutate(p = n_indivs/n_indivs_total)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_filter_site |> \n  ggplot() +\n  aes(\n    x = size_class, \n    y = p\n  ) +\n  geom_point() + \n  geom_line() +\n  facet_wrap(~species_name)\n```\n\n::: {.cell-output-display}\n![](universal_files/figure-html/singlesite-plot-ssd-1.png){width=672}\n:::\n:::\n\n\nA single site does not give you much information. What about a single ecoregion?\n\n### Single ecoregion\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# \"Bassian\" is the ecoregion with most surveys\nselected_ecoregion <- \n  survey_list |> \n  add_count(ecoregion) |> \n  arrange(desc(n)) |> \n  head(1) |> \n  pull(ecoregion)\n\n\ndata_filter_ecor <- \n  obs_data |> \n  left_join(survey_list, by = join_by(survey_id)) |> \n  filter(ecoregion == selected_ecoregion) |> \n  count(species_name, size_class, name = \"n_indivs\") |> \n  add_count(species_name, \n            wt = n_indivs,\n            name = \"n_indivs_total\") |> \n  mutate(p = n_indivs/n_indivs_total)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_filter_ecor |> \n  ggplot() +\n  aes(\n    x = size_class, \n    y = p\n  ) +\n  geom_point() + \n  geom_line() +\n  facet_wrap(~species_name)\n```\n\n::: {.cell-output-display}\n![](universal_files/figure-html/singleecor-plot-ssd-1.png){width=672}\n:::\n:::\n\n\nThese look more like reasonable distributions.\n\n### Single ecoregion through time\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_filter_ecor_byyear <- \n  obs_data |> \n  left_join(survey_list, by = join_by(survey_id)) |> \n  filter(ecoregion == selected_ecoregion) |> \n  mutate(year = year(survey_date) |> as.integer()) |> \n  count(species_name, size_class, year,\n        name = \"n_indivs\") |> \n  add_count(species_name, \n            year,\n            wt = n_indivs,\n            name = \"n_indivs_total\") |> \n  mutate(p = n_indivs/n_indivs_total) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfor(yr in sort(unique(data_filter_ecor_byyear$year))){\n  \n  file_name <- paste0(\"output/figs/singleecor_byyear/\", yr,\".png\")\n  if(!file.exists(file_name)){\n      dat <- \n    data_filter_ecor_byyear |> \n    mutate(p = ifelse(year == yr, p, NA))\n  \n  plot <-  \n     dat|> \n    ggplot() +\n    aes(\n      x = size_class, \n      y = p\n    ) +\n    geom_point() + \n    geom_path(data = dat |> drop_na()) +\n    facet_wrap(~species_name) \n  \n  \n    ggsave(filename = file_name, \n           plot = plot)\n  } \n\n}\n\n\n\n#\"output/figs/singleecor_byyear/\" |> \n#  list.files(full.names = TRUE) |> \n # map(image_read) |> \n  #image_join() |> \n  #image_animate(fps = 1) |> \n  #image_write(path = \"output/figs/singleecor_byyear/ssd.gif\")\n\n\n\n# xx2 <- image_join(xx)\n# xx3 <- image_animate(xx2, fps = 1)\n# image_write(xx3, path = \"output/figs/singleecor_byyear/ssd.gif\")\n```\n:::\n",
    "supporting": [
      "universal_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}