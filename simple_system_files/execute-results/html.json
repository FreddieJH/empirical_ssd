{
  "hash": "774ebcb352ced4648ec153560c06750b",
  "result": {
    "markdown": "---\ntitle: \"Starting simple\"\nauthor: \"Freddie Heather, Shane Richards, & Asta Audzijonyte\"\ndate: last-modified\nformat: html\neditor: visual\nauthor-title: \"Authors\"\npublished-title: \"Last modified\"\nbibliography: references.bib\n---\n\n\n\n\n## Set-up\n\n### Required packages\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(arrow)\nlibrary(rstan)\n```\n:::\n\n\nWe want to chose a subsection of fish species from the RLS dataset. These species should ideally be non-target species for fisheries, should cover multiple size classes, and should be relatively abundant.\n\n### Non-target species\n\nSpecies-level fishing pressure data are taken from supplementary table 1 of @audzijonyte2020.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Species that we will consider (minimal fishing pressure)\nnontarget_spp <- \n  read_csv(\"data/raw/audzijonyte_nee_supplementary_table_1_fishing.csv\") %>% \n  filter(fisheries_target == \"rarely\") %>% \n  pull(species)\n\nhead(nontarget_spp)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"Abudefduf bengalensis\"         \"Abudefduf sexfasciatus\"       \n[3] \"Abudefduf vaigiensis\"          \"Abudefduf whitleyi\"           \n[5] \"Acanthaluteres spilomelanurus\" \"Acanthochromis polyacanthus\"  \n```\n:::\n:::\n\n\n### Relatively abundant species\n\nFor this we need abundance data. These data are from all across Australia.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Each row is a single individual observation\nobs_data <- read_parquet(\"data/raw/obs_data_m1_aus.parquet\")\n\nhead(obs_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 x 3\n  survey_id species_name          size_class\n      <dbl> <chr>                      <dbl>\n1   2000854 Achoerodus viridis          50  \n2   2000854 Achoerodus viridis          62.5\n3   2000854 Achoerodus viridis         112. \n4   2000854 Aplodactylus lophodon       15  \n5   2000854 Aplodactylus lophodon       20  \n6   2000854 Atypichthys strigatus        2.5\n```\n:::\n:::\n\n\nWe are selecting species that are in the 90% percentile of abundance.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspp_byabundance <- \n  read_parquet(\"data/raw/obs_data_m1_aus.parquet\") %>% \n  count(species_name) %>% \n  arrange(desc(n)) \n\n# The 90% percentile of abundance\nabundance_cutoff <- \n  spp_byabundance %>% \n  pull(n) %>% \n  quantile(probs = 0.9) %>% \n  as.numeric()\n\nabundant_spp <- \n  spp_byabundance %>% \n  filter(n >= abundance_cutoff) %>% \n  pull(species_name)\n```\n:::\n\n\n### Range of body sizes\n\nTo satisfy this criteria, we are selecting species from the full range of mean body sizes. Species are selected from equally spaced from the smallest to the largest mean body size.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# How many species we want to model\nn_spp <- 500\n\nsuitable_spp <- \n  obs_data %>% \n  group_by(species_name) |> \n  summarise(mean_size = mean(size_class), \n            .groups = \"drop\") %>% \n  arrange(mean_size) %>% \n  filter(species_name %in% nontarget_spp) %>% \n  filter(species_name %in% abundant_spp)\n\n# Of the suitable species we want an equal spacing of body size\nequal_spaced_bodysize <- \n  seq(from = 1, to = nrow(suitable_spp), length.out = n_spp) %>% round()\n\n# 20 species across the range of sizes\nselected_spp <- \n  suitable_spp[equal_spaced_bodysize, ] %>% \n  pull(species_name)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# The most abundant species (number specified above)\n# only selecting non-target species\nselected_spp <- \n  read_parquet(\"data/raw/obs_data_m1_aus.parquet\") %>% \n  count(species_name) %>% \n  arrange(desc(n)) %>% \n  filter(species_name %in% nontarget_spp) %>% \n  head(n_spp) %>% \n  pull(species_name)\n\n# The selected species\nselected_spp\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  [1] \"Trachinops taeniatus\"              \"Trachinops caudimaculatus\"        \n  [3] \"Atypichthys strigatus\"             \"Chromis hypsilepis\"               \n  [5] \"Trachinops noarlungae\"             \"Pomacentrus moluccensis\"          \n  [7] \"Pomacentrus coelestis\"             \"Chromis nitida\"                   \n  [9] \"Schuettea scalaripinnis\"           \"Chromis atripectoralis\"           \n [11] \"Caesioperca rasor\"                 \"Acanthochromis polyacanthus\"      \n [13] \"Pomacentrus lepidogenys\"           \"Pempheris multiradiata\"           \n [15] \"Chlorurus sordidus\"                \"Chromis margaritifer\"             \n [17] \"Pempheris compressa\"               \"Caesio cuning\"                    \n [19] \"Thalassoma lunare\"                 \"Ctenochaetus striatus\"            \n [21] \"Parapriacanthus elongatus\"         \"Pempheris klunzingeri\"            \n [23] \"Chromis viridis\"                   \"Dascyllus reticulatus\"            \n [25] \"Caesioperca lepidoptera\"           \"Chromis ternatensis\"              \n [27] \"Thalassoma amblycephalum\"          \"Pomacentrus wardi\"                \n [29] \"Pomacentrus milleri\"               \"Pempheris affinis\"                \n [31] \"Pomacentrus vaiuli\"                \"Pterocaesio digramma\"             \n [33] \"Amblyglyphidodon curacao\"          \"Pseudolabrus luculentus\"          \n [35] \"Acanthurus nigrofuscus\"            \"Parma microlepis\"                 \n [37] \"Thalassoma lutescens\"              \"Dascyllus aruanus\"                \n [39] \"Plectroglyphidodon lacrymatus\"     \"Dascyllus trimaculatus\"           \n [41] \"Pomacentrus brachialis\"            \"Chromis weberi\"                   \n [43] \"Pomacentrus philippinus\"           \"Cirrhilabrus punctatus\"           \n [45] \"Chromis westaustralis\"             \"Pomacentrus amboinensis\"          \n [47] \"Chromis atripes\"                   \"Chromis amboinensis\"              \n [49] \"Parma unifasciata\"                 \"Stegastes gascoynei\"              \n [51] \"Chromis chrysura\"                  \"Pseudanthias tuka\"                \n [53] \"Pomacentrus bankanensis\"           \"Abudefduf sexfasciatus\"           \n [55] \"Stegastes fasciolatus\"             \"Caesioscorpis theagenes\"          \n [57] \"Cheilodipterus quinquelineatus\"    \"Parma mccullochi\"                 \n [59] \"Pomacentrus adelus\"                \"Halichoeres melanurus\"            \n [61] \"Halichoeres nebulosus\"             \"Labroides dimidiatus\"             \n [63] \"Siphonognathus beddomei\"           \"Neoodax balteatus\"                \n [65] \"Chromis klunzingeri\"               \"Zebrasoma scopas\"                 \n [67] \"Stegastes nigricans\"               \"Thalassoma hardwicke\"             \n [69] \"Schuettea woodwardi\"               \"Plotosus lineatus\"                \n [71] \"Austrolabrus maculatus\"            \"Caesio teres\"                     \n [73] \"Amblyglyphidodon leucogaster\"      \"Scarus rivulatus\"                 \n [75] \"Apogon limenus\"                    \"Neoglyphidodon nigroris\"          \n [77] \"Halichoeres brownfieldi\"           \"Aplodactylus lophodon\"            \n [79] \"Caesio caerulaurea\"                \"Acanthurus triostegus\"            \n [81] \"Scarus schlegeli\"                  \"Ctenochaetus binotatus\"           \n [83] \"Pseudanthias squamipinnis\"         \"Acanthurus grammoptilus\"          \n [85] \"Pterocaesio tile\"                  \"Kyphosus sectatrix\"               \n [87] \"Hypoplectrodes maccullochi\"        \"Leptojulis cyanopleura\"           \n [89] \"Parma victoriae\"                   \"Stegastes obreptus\"               \n [91] \"Scolopsis bilineata\"               \"Torquigener pleurogramma\"         \n [93] \"Gomphosus varius\"                  \"Scarus ghobban\"                   \n [95] \"Coris batuensis\"                   \"Parma polylepis\"                  \n [97] \"Stethojulis bandanensis\"           \"Pomacentrus nagasakiensis\"        \n [99] \"Paracaesio xanthura\"               \"Neatypus obliquus\"                \n[101] \"Pterocaesio marri\"                 \"Pterocaesio trilineata\"           \n[103] \"Halichoeres hortulanus\"            \"Stethojulis interrupta\"           \n[105] \"Abudefduf bengalensis\"             \"Chaetodon aureofasciatus\"         \n[107] \"Abudefduf vaigiensis\"              \"Siganus fuscescens\"               \n[109] \"Apogon doederleini\"                \"Ptereleotris evides\"              \n[111] \"Anampses neoguinaicus\"             \"Halichoeres trimaculatus\"         \n[113] \"Chromis xanthura\"                  \"Microcanthus strigatus\"           \n[115] \"Labrichthys unilineatus\"           \"Pseudolabrus biserialis\"          \n[117] \"Abudefduf whitleyi\"                \"Pomacentrus australis\"            \n[119] \"Plagiotremus tapeinosoma\"          \"Lutjanus gibbus\"                  \n[121] \"Chaetodon tricinctus\"              \"Monodactylus argenteus\"           \n[123] \"Tilodon sexfasciatus\"              \"Acanthurus nigricans\"             \n[125] \"Amphiprion akindynos\"              \"Anampses geographicus\"            \n[127] \"Halichoeres nigrescens\"            \"Cirrhilabrus exquisitus\"          \n[129] \"Kyphosus bigibbus\"                 \"Gerres subfasciatus\"              \n[131] \"Stethojulis strigiventer\"          \"Pomacentrus grammorhynchus\"       \n[133] \"Thalassoma quinquevittatum\"        \"Gnathodentex aureolineatus\"       \n[135] \"Mecaenichthys immaculatus\"         \"Chaetodon plebeius\"               \n[137] \"Thalassoma nigrofasciatum\"         \"Parma occidentalis\"               \n[139] \"Mulloidichthys vanicolensis\"       \"Neoglyphidodon melas\"             \n[141] \"Pomacentrus chrysurus\"             \"Plectroglyphidodon johnstonianus\" \n[143] \"Dotalabrus aurantiacus\"            \"Acanthurus lineatus\"              \n[145] \"Chaetodon lunulatus\"               \"Anampses elegans\"                 \n[147] \"Plectroglyphidodon dickii\"         \"Scarus chameleon\"                 \n[149] \"Halichoeres biocellatus\"           \"Pseudocheilinus hexataenia\"       \n[151] \"Eupetrichthys angustipes\"          \"Chelmonops curiosus\"              \n[153] \"Dischistodus prosopotaenia\"        \"Scarus niger\"                     \n[155] \"Stegastes apicalis\"                \"Scarus frenatus\"                  \n[157] \"Halichoeres melanochir\"            \"Centropyge bispinosa\"             \n[159] \"Zanclus cornutus\"                  \"Chaetodon trifascialis\"           \n[161] \"Ctenochaetus cyanocheilus\"         \"Coris picta\"                      \n[163] \"Chaetodon pelewensis\"              \"Chironemus marmoratus\"            \n[165] \"Dischistodus melanotus\"            \"Hemiglyphidodon plagiometopon\"    \n[167] \"Acanthurus nigricauda\"             \"Acanthurus blochii\"               \n[169] \"Monotaxis heterodon\"               \"Chaetodon citrinellus\"            \n[171] \"Hipposcarus longiceps\"             \"Amblygobius phalaena\"             \n[173] \"Pictilabrus viridis\"               \"Centropyge vrolikii\"              \n[175] \"Scarus prasiognathos\"              \"Hemitaurichthys polylepis\"        \n[177] \"Ostorhinchus compressus\"           \"Halichoeres marginatus\"           \n[179] \"Monotaxis grandoculis\"             \"Mulloidichthys flavolineatus\"     \n[181] \"Naso unicornis\"                    \"Heteroscarus acroptilus\"          \n[183] \"Pempheris analis\"                  \"Ptereleotris microlepis\"          \n[185] \"Naso lituratus\"                    \"Acanthurus olivaceus\"             \n[187] \"Cheilinus chlorourus\"              \"Siganus virgatus\"                 \n[189] \"Acanthurus dussumieri\"             \"Oxymonacanthus longirostris\"      \n[191] \"Siganus doliatus\"                  \"Chelmon marginalis\"               \n[193] \"Diodon nicthemerus\"                \"Halichoeres miniatus\"             \n[195] \"Chaetodon auriga\"                  \"Chaetodon flavirostris\"           \n[197] \"Scarus altipinnis\"                 \"Scarus flavipectoralis\"           \n[199] \"Chaetodon kleinii\"                 \"Acanthurus nigroris\"              \n[201] \"Sufflamen chrysopterum\"            \"Paracirrhites arcatus\"            \n[203] \"Chromis xanthochira\"               \"Naso tonganus\"                    \n[205] \"Naso brevirostris\"                 \"Parapercis haackei\"               \n[207] \"Dischistodus pseudochrysopoecilus\" \"Apogon victoriae\"                 \n[209] \"Chaetodon rainfordi\"               \"Ostorhinchus aureus\"              \n[211] \"Centropyge bicolor\"                \"Forcipiger flavissimus\"           \n[213] \"Coris aygula\"                      \"Myripristis kuntee\"               \n[215] \"Cirripectes filamentosus\"          \"Chaetodon guentheri\"              \n[217] \"Centropyge tibicen\"                \"Pempheris oualensis\"              \n[219] \"Dischistodus perspicillatus\"       \"Pseudochromis fuscus\"             \n[221] \"Chaetodon melannotus\"              \"Cheilinus fasciatus\"              \n[223] \"Brachaluteres jacksonianus\"        \"Paracirrhites forsteri\"           \n[225] \"Acanthaluteres spilomelanurus\"     \"Canthigaster valentini\"           \n[227] \"Acanthurus pyroferus\"              \"Thalassoma jansenii\"              \n[229] \"Meiacanthus atrodorsalis\"          \"Epibulus insidiator\"              \n[231] \"Cheilinus trilobatus\"              \"Labroides bicolor\"                \n[233] \"Plagiotremus rhinorhynchos\"        \"Myripristis violacea\"             \n[235] \"Pseudanthias pascalus\"             \"Macropharyngodon meleagris\"       \n[237] \"Pomacanthus sexstriatus\"           \"Myripristis vittata\"              \n[239] \"Parequula melbournensis\"           \"Oxycheilinus unifasciatus\"        \n[241] \"Neoniphon sammara\"                 \"Chaetodon mertensii\"              \n[243] \"Halichoeres margaritaceus\"         \"Chaetodon baronessa\"              \n[245] \"Aracana aurita\"                    \"Dotalabrus alleni\"                \n[247] \"Serranocirrhitus latus\"            \"Kyphosus cinerascens\"             \n[249] \"Acanthurus albipectoralis\"         \"Labropsis australis\"              \n[251] \"Valenciennea muralis\"             \n```\n:::\n\n```{.r .cell-code}\nwrite_rds(selected_spp, \"output/data/selected_spp.rds\")\n```\n:::\n\n\n## Data wrangling\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspp_list <- \n  tibble(\n    species_name = selected_spp, \n    species_indx = 1:length(selected_spp)\n  )\n\nobs_data_filter <- \n  obs_data %>% \n  filter(species_name %in% selected_spp)\n\n# create a vector of bin length boundaries\ncutoff <- c(\n  2.5, 5, 7.5, 10, 12.5, 15, 20, 25, 30, 35, 40, 50, \n  seq(from = 62.5, to = 200, by = 12.5), \n  seq(from = 250, to = 500, by = 50))\n\nrls_bins <- c(0, cutoff)\n\n# create a data frame that links fish lengths with bin indices\ndf_cutoff <- tibble(\n  size_class = cutoff,\n  size_indx = 1:length(cutoff)\n)\n\n# add bin indices to the dataset\ndf_single <- \n  obs_data_filter %>% \n  left_join(df_cutoff, \n            by = \"size_class\")\n\n# calculate species counts and mean species lengths\ndf_abundance <- \n  df_single %>%\n  left_join(spp_list, \n            by = \"species_name\") %>% \n  summarise(Total_N = n(), \n            Mean_L = mean(size_class), \n            .by = \"species_indx\") %>%\n  left_join(spp_list, by = \"species_indx\")\n\n# group counts of same species of same size \ndf_fit <- \n  df_single %>%\n  left_join(spp_list, \n            by = \"species_name\") %>% \n  summarise( n = n(), \n             .by = c(species_indx, size_indx)) %>%   # calc fish in bin\n  left_join(df_cutoff, by = \"size_indx\") %>% # add size class info\n  left_join(df_abundance, by = \"species_indx\") %>% # add species abundances\n  mutate(f_obs = n/Total_N) # calc fraction of individuals in size class\n\nglimpse(df_fit) # show info used when fitting\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 2,310\nColumns: 8\n$ species_indx <int> 78, 78, 3, 3, 3, 223, 36, 36, 36, 17, 1, 1, 3, 3, 4, 36, ~\n$ size_indx    <int> 6, 7, 1, 2, 3, 1, 3, 4, 5, 2, 1, 2, 4, 5, 2, 1, 6, 1, 2, ~\n$ n            <int> 1329, 3101, 43772, 155106, 252391, 679, 9099, 13044, 1596~\n$ size_class   <dbl> 15.0, 20.0, 2.5, 5.0, 7.5, 2.5, 7.5, 10.0, 12.5, 5.0, 2.5~\n$ Total_N      <int> 18359, 18359, 702098, 702098, 702098, 2129, 60328, 60328,~\n$ Mean_L       <dbl> 26.673021, 26.673021, 8.054128, 8.054128, 8.054128, 4.778~\n$ species_name <chr> \"Aplodactylus lophodon\", \"Aplodactylus lophodon\", \"Atypic~\n$ f_obs        <dbl> 0.072389564, 0.168908982, 0.062344573, 0.220917878, 0.359~\n```\n:::\n:::\n\n\n## *Data plots*\n\n\n::: {.cell height='3'}\n\n```{.r .cell-code}\ndf_fit %>% \n  filter(species_name %in% sample(selected_spp, size = 50)) |> \n  ggplot() + \n  aes(x = size_class, \n      y = n) + \n  geom_point() + \n  geom_line() +\n  facet_wrap( ~ species_name, ncol = 5) +\n  scale_y_log10() + \n  scale_x_log10() +\n  labs(x = \"Log Fish length (cm)\",  \n       y = \"Log Fish abundance\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](simple_system_files/figure-html/unnamed-chunk-9-1.png){width=864}\n:::\n:::\n\n::: {.cell height='3'}\n\n```{.r .cell-code}\ndf_fit %>% \n  filter(species_name %in% sample(selected_spp, size = 50)) |> \n  ggplot() + \n  aes(x = size_class, \n      y = n) + \n  geom_point() + \n  geom_line() +\n  facet_wrap( ~ species_name, ncol = 5) +\n  scale_y_log10() + \n  labs(x = \"Fish length (cm)\",\n       y = \"Log Fish abundance\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](simple_system_files/figure-html/unnamed-chunk-10-1.png){width=864}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_abundance %>% \n  ggplot() +\n  aes(x = Mean_L, y = Total_N) +\n  geom_point(color = \"red\") + \n  labs(x = \"Observed mean fish length (cm)\", \n       y = \"Abundance\") +\n  scale_y_log10() +\n  scale_x_log10() + \n  theme_bw() +\n  stat_smooth(method = \"loess\", \n              formula = \"y ~ x\")\n```\n\n::: {.cell-output-display}\n![](simple_system_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n## *Bayesian Model Fit*\n\n### Model set up\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstan_dat <- list(\n  I = nrow(df_fit), # number of observations\n  S = max(df_fit$species_indx), # number of species\n  B = max(df_fit$size_indx), # number of bins\n  l = cutoff[1:max(df_fit$size_indx)], # length cut-offs\n  s = df_fit$species_indx, # species\n  b = df_fit$size_indx, # length bin\n  n = df_fit$n) # individual counts    \n\nglimpse(stan_dat) # show data fed to rstan\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nList of 7\n $ I: int 2310\n $ S: int 251\n $ B: int 23\n $ l: num [1:23] 2.5 5 7.5 10 12.5 15 20 25 30 35 ...\n $ s: int [1:2310] 78 78 3 3 3 223 36 36 36 17 ...\n $ b: int [1:2310] 6 7 1 2 3 1 3 4 5 2 ...\n $ n: int [1:2310] 1329 3101 43772 155106 252391 679 9099 13044 15965 16354 ...\n```\n:::\n:::\n\n\n### Running the model\n\n<!-- ```{r} -->\n\n\n<!-- if(!file.exists(\"output/stan/lnorm_fit.rds\")){ -->\n<!--   # fit the log-normal pdf model! -->\n<!-- stan(file = 'data/stan_models/LogNormalFit_FJH.stan',  -->\n<!--                data = stan_dat, -->\n<!--                iter = 600,  -->\n<!--                warmup = 200,  -->\n<!--                chains = 3,  -->\n<!--                refresh = 200) |>  -->\n<!-- saveRDS(\"output/stan/lnorm_fit.rds\") -->\n<!-- } -->\n\n<!-- fit_ln <- readRDS(\"output/stan/lnorm_fit.rds\") -->\n\n\n<!-- ``` -->\n\n<!-- ### Checking the model fit -->\n\n<!-- ```{r} -->\n<!-- # check out some predicted model parameters and log-likelihood -->\n<!-- model_par <- c(\"lp__\",  -->\n<!--                \"ln_sigma[1]\", -->\n<!--                \"ln_sigma[2]\", -->\n<!--                \"ln_sigma[3]\", -->\n<!--                \"ln_mu[1]\",  -->\n<!--                \"ln_mu[2]\",  -->\n<!--                \"ln_mu[3]\") -->\n\n<!-- # check for chain convergence -->\n<!-- rstan::traceplot(object = fit_ln,  -->\n<!--                  pars = model_par,  -->\n<!--                  inc_warmup = TRUE,  -->\n<!--                  ncol = 5) -->\n\n\n\n<!-- ``` -->\n\n<!-- ### Summarising the model coefficients -->\n\n<!-- ```{r} -->\n\n<!-- # calculate the predicted mean length of each species and 90% credible interval -->\n<!-- l_par <- rstan::extract(fit_ln, pars = c(\"ln_sigma\", \"ln_mu\")) -->\n\n<!-- par_table <-  -->\n<!--   tibble( -->\n<!--     # CHECK THIS: IS THIS THE RIGHT ORDER OF THE SPECIES NAMES??? -->\n<!--     species_name = spp_list$species_name, -->\n<!--     ln_sigma = l_par$ln_sigma[1,], -->\n<!--        ln_mu = l_par$ln_mu[1,])  -->\n\n<!-- par_table_long <-  -->\n<!--   par_table |>  -->\n<!--   pivot_longer(cols = c(ln_sigma, ln_mu), -->\n<!--                names_to = \"par\") -->\n\n\n<!-- par_table_long |>  -->\n<!--   ggplot() + -->\n<!--   aes(x = value,  -->\n<!--       col = par) +  -->\n<!--   geom_density() -->\n\n\n<!-- df_abundance |>  -->\n<!--   left_join(par_table) |>  -->\n<!--   ggplot() + -->\n<!--   aes( -->\n<!--     x = Mean_L,  -->\n<!--     y = ln_mu -->\n<!--   ) + -->\n<!--   geom_point() + -->\n<!--   geom_line(aes(y = log(Mean_L))) -->\n\n\n<!-- df_abundance |>  -->\n<!--   left_join(par_table) |>  -->\n<!--   ggplot() + -->\n<!--   aes( -->\n<!--     x = Mean_L,  -->\n<!--     y = ln_sigma -->\n<!--   ) + -->\n<!--   geom_point() -->\n\n\n<!-- par_table |>  -->\n<!--   ggplot() + -->\n<!--   aes(x = ln_mu,  -->\n<!--       y = ln_sigma |> exp()) + -->\n<!--   geom_point() -->\n\n\n<!-- ``` -->\n\n<!-- ### Comparing observed and modelled scaled size -->\n\n<!-- ```{r} -->\n\n<!-- func1 <- function(df) { -->\n\n<!--   tibble( -->\n<!--     x = seq(1, 100, by = 0.2),  -->\n<!--     y =  -->\n<!--   dlnorm(x = x,  -->\n<!--          meanlog = df$ln_mu,  -->\n<!--          sdlog = exp(df$ln_sigma)) -->\n<!--   ) -->\n<!-- } -->\n\n<!-- par_table |>  -->\n<!--   group_nest(species_name) |>  -->\n<!--   mutate(new = map(.x = data,  -->\n<!--                    .f = func1)) |>  -->\n<!--   unnest(cols = c(new, data)) |>  -->\n<!--   left_join(df_abundance,  -->\n<!--             by = join_by(species_name)) |>  -->\n<!--   mutate(x_scaled = x/Mean_L) |>  -->\n<!--   ggplot() + -->\n<!--   aes(x = x_scaled |> log(),  -->\n<!--       y = y |> log(),  -->\n<!--       col = species_name) + -->\n<!--   geom_path() + -->\n<!--   theme(legend.position = \"none\") -->\n\n\n<!-- df_fit |>  -->\n<!--   select(species_name, n, size_class, Mean_L, Total_N) |>  -->\n<!--   mutate(scaled_n = n/Total_N,  -->\n<!--          scaled_l = size_class/Mean_L) |>  -->\n<!--   ggplot() +  -->\n<!--   aes(  -->\n<!--     x = log(scaled_l), -->\n<!--     y = log(scaled_n)) + -->\n<!--   geom_path(aes(col = species_name),  -->\n<!--             alpha = 0.2) + -->\n<!--   theme(legend.position = \"none\") + -->\n<!--   geom_smooth() -->\n\n<!-- ``` -->\n\n<!-- ```{r} -->\n\n<!-- # calculate the predicted mean length of each species and 90% credible interval -->\n<!-- l_par <- rstan::extract(fit_ln,  -->\n<!--                         pars = c(\"ln_sigma\", \"ln_mu\")) -->\n\n<!-- df_pred_spp <- tibble(Spp = 1:S) # create a data frame -->\n<!-- # add quantiles of predicted mean fish lengths -->\n<!-- df_pred_spp$medn = exp(apply(X = l_par$ln_mu,  -->\n<!--                              MARGIN = 2,  -->\n<!--                              FUN = quantile,  -->\n<!--                              probs = 0.5)) -->\n<!-- df_pred_spp$lwr90 = exp(apply(X = l_par$ln_mu,  -->\n<!--                               MARGIN = 2,  -->\n<!--                               FUN = quantile,  -->\n<!--                               probs = 0.05)) -->\n<!-- df_pred_spp$upp90 = exp(apply(X = l_par$ln_mu,  -->\n<!--                               MARGIN = 2,  -->\n<!--                               FUN = quantile,  -->\n<!--                               probs = 0.95)) -->\n\n<!-- ggplot(df_pred_spp) + -->\n<!--   geom_errorbar(aes(x = Spp, ymin = lwr90, ymax = upp90), width = 0.2) + -->\n<!--   geom_point(aes(x =Spp, y = medn)) + -->\n<!--   labs( -->\n<!--     x = \"Species id\",  -->\n<!--     y = \"Median length (cm)\",  -->\n<!--     subtitle = \"Bars = 90%CI for median\") + -->\n<!--   theme_bw() -->\n\n<!-- ``` -->\n\n<!-- ```{r} -->\n<!-- # for each species and bin size predict probability of fish being in the bin -->\n<!-- df_predict$p_ln = 0.0 # create a column -->\n\n<!-- for (i in 1:nrow(df_predict)) { -->\n<!--   if (df_predict$size_indx[i] == 1)\t{ # special case for smallest bin -->\n<!--     p_all <- plnorm(cutoff[1], meanlog = l_par$ln_mu[ ,df_predict$spp_id[i]],  -->\n<!--                     sdlog = exp(l_par$ln_sigma)) -->\n<!--   } else { # larger bins -->\n<!--     p_all <- plnorm(cutoff[df_predict$size_indx[i]], meanlog = l_par$ln_mu[ -->\n<!--       ,df_predict$spp_id[i]], sdlog = exp(l_par$ln_sigma)) - -->\n<!--       plnorm(cutoff[df_predict$size_indx[i]-1], meanlog = l_par$ln_mu[ -->\n<!--         ,df_predict$spp_id[i]], sdlog = exp(l_par$ln_sigma)) -->\n<!--   } -->\n<!--   df_predict$p_ln[i] <- mean(p_all) # store the mean predicted probability -->\n<!-- } -->\n<!-- ``` -->\n\n<!-- ```{r fig.width=9, fig.height=7} -->\n<!-- ggplot() + -->\n<!--   geom_point(data = filter(df_predict, spp_id %in% spp_plotted), aes(x = size_class, y = p_ln), color = \"purple\", size = 1) + -->\n<!--   geom_line(data = filter(df_predict, spp_id %in% spp_plotted), aes(x = size_class, y = p_ln), color = \"purple\") + -->\n<!--   geom_point(data = filter(df_fit, spp_id %in% spp_plotted), aes(x = size_class, y = f_obs), color= \"black\", size = 2) + -->\n<!--   facet_wrap( ~ spp_id, ncol = 5) + -->\n<!--   labs(x = \"Size class (cm)\", y = \"Probability\") + -->\n<!--   theme_bw() -->\n<!-- ``` -->\n\n<!-- <!-- ```{r} --> -->\n\n<!-- <!-- fit_n <-  --> -->\n\n<!-- <!--   stan( --> -->\n\n<!-- <!--     file = \"data/stan_models/NormalFit.stan\",  --> -->\n\n<!-- <!--     data = stan_dat, --> -->\n\n<!-- <!--     iter = 1000,  --> -->\n\n<!-- <!--     warmup = 500,  --> -->\n\n<!-- <!--     chains = 3,  --> -->\n\n<!-- <!--     refresh = 300,  --> -->\n\n<!-- <!--     seed = 1,  --> -->\n\n<!-- <!--   ) --> -->\n\n<!-- <!-- ``` --> -->\n\n<!-- <!-- Model does not want to run, the chains do not converge and we get a large R-hat value --> -->\n\n<!-- <!-- ```{r} --> -->\n\n<!-- <!-- # check out some predicted model parameters and log-likelihood --> -->\n\n<!-- <!-- model_par <- c(\"lp__\", \"ln_cv\", \"ln_mu[1]\", \"ln_mu[10]\", \"ln_mu[20]\") --> -->\n\n<!-- <!-- # check for chain convergence --> -->\n\n<!-- <!-- rstan::traceplot(object = fit_n, pars = model_par, inc_warmup = TRUE, ncol = 5) --> -->\n\n<!-- <!-- ``` --> -->\n\n<!-- <!-- ### *Model predictions* --> -->\n\n<!-- <!-- ```{r} --> -->\n\n<!-- <!-- # calculate the predicted mean length of each species and 90% credible interval --> -->\n\n<!-- <!-- l_par <- rstan::extract(fit_n, pars = c(\"ln_cv\", \"ln_mu\")) --> -->\n\n<!-- <!-- df_pred_spp <- tibble(Spp = 1:S) # create a data frame --> -->\n\n<!-- <!-- # add quantiles of predicted mean fish lengths --> -->\n\n<!-- <!-- df_pred_spp$medn = exp(apply(X = l_par$ln_mu, MARGIN = 2, FUN = quantile,  --> -->\n\n<!-- <!--                              probs = 0.5)) --> -->\n\n<!-- <!-- df_pred_spp$lwr90 = exp(apply(X = l_par$ln_mu, MARGIN = 2, FUN = quantile,  --> -->\n\n<!-- <!--                               probs = 0.05)) --> -->\n\n<!-- <!-- df_pred_spp$upp90 = exp(apply(X = l_par$ln_mu, MARGIN = 2, FUN = quantile,  --> -->\n\n<!-- <!--                               probs = 0.95)) --> -->\n\n<!-- <!-- ggplot(df_pred_spp) + --> -->\n\n<!-- <!--   geom_errorbar(aes(x = Spp, ymin = lwr90, ymax = upp90), width = 0.2) + --> -->\n\n<!-- <!--   geom_point(aes(x =Spp, y = medn)) + --> -->\n\n<!-- <!--   labs(x = \"Species id\", y = \"Mean length (cm)\", subtitle = \"Bars = 90%CI for mean\") + --> -->\n\n<!-- <!--   theme_bw() --> -->\n\n<!-- <!-- ``` --> -->\n\n<!-- <!-- ```{r} --> -->\n\n<!-- <!-- # for each species and bin size predict probability of fish being in the bin --> -->\n\n<!-- <!-- df_predict <- expand_grid( --> -->\n\n<!-- <!--   spp_id = 1:S, size_indx = 1:B) --> -->\n\n<!-- <!-- df_predict$p_n = 0.0 # create a column --> -->\n\n<!-- <!-- for (i in 1:nrow(df_predict)) { --> -->\n\n<!-- <!--   if (df_predict$size_indx[i] == 1)    { # special case for smallest bin --> -->\n\n<!-- <!--     p_all <- pnorm(cutoff[1], mean = exp(l_par$ln_mu[ ,df_predict$spp_id[i]]),  --> -->\n\n<!-- <!--                    sd = exp(l_par$ln_mu[ ,df_predict$spp_id[i]])*exp(l_par$ln_cv)) --> -->\n\n<!-- <!--   } else { # larger bins --> -->\n\n<!-- <!--     p_all <- pnorm(cutoff[df_predict$size_indx[i]], mean = exp(l_par$ln_mu[ ,df_predict$spp_id[i]]),  --> -->\n\n<!-- <!--                    sd = exp(l_par$ln_mu[ ,df_predict$spp_id[i]])*exp(l_par$ln_cv)) - --> -->\n\n<!-- <!--       pnorm(cutoff[df_predict$size_indx[i]-1], mean = exp(l_par$ln_mu[ ,df_predict$spp_id[i]]),  --> -->\n\n<!-- <!--             sd = exp(l_par$ln_mu[ ,df_predict$spp_id[i]])*exp(l_par$ln_cv)) --> -->\n\n<!-- <!--   } --> -->\n\n<!-- <!--   df_predict$p_n[i] <- mean(p_all) # store the mean predicted probability --> -->\n\n<!-- <!-- } --> -->\n\n<!-- <!-- df_predict <- left_join(df_predict, df_cutoff, by = \"size_indx\") # add bin sizes --> -->\n\n<!-- <!-- ``` --> -->\n\n<!-- <!-- ```{r fig.width=9, fig.height=7} --> -->\n\n<!-- <!-- ggplot() + --> -->\n\n<!-- <!--   geom_point(data = filter(df_predict, spp_id %in% spp_plotted), aes(x = size_class, y = p_n), color = \"red\", size = 1) + --> -->\n\n<!-- <!--   geom_line(data = filter(df_predict, spp_id %in% spp_plotted), aes(x = size_class, y = p_n), color = \"red\") + --> -->\n\n<!-- <!--   geom_point(data = filter(df_fit, spp_id %in% spp_plotted), aes(x = size_class, y = f_obs), color= \"black\", size = 2) + --> -->\n\n<!-- <!--   facet_wrap( ~ spp_id, ncol = 5) + --> -->\n\n<!-- <!--   labs(x = \"Size class (cm)\", y = \"Probability\") + --> -->\n\n<!-- <!--   theme_bw() --> -->\n\n<!-- <!-- ``` --> -->\n\n<!-- ```{r fig.width=9, fig.height=7} -->\n<!-- ggplot() + -->\n<!--   geom_point(data = filter(df_predict, spp_id %in% spp_plotted, p_n > 0.001),  -->\n<!--              aes(x = size_class, y = p_n), color = \"red\", size = 1) + -->\n<!--   geom_line(data = filter(df_predict, spp_id %in% spp_plotted, p_n > 0.001),  -->\n<!--             aes(x = size_class, y = p_n), color = \"red\") + -->\n<!--   geom_point(data = filter(df_predict, spp_id %in% spp_plotted, p_ln > 0.001),  -->\n<!--              aes(x = size_class, y = p_ln), color = \"purple\", size = 1) + -->\n<!--   geom_line(data = filter(df_predict, spp_id %in% spp_plotted, p_ln > 0.001),  -->\n<!--             aes(x = size_class, y = p_ln), color = \"purple\") + -->\n<!--   geom_point(data = filter(df_fit, spp_id %in% spp_plotted),  -->\n<!--              aes(x = size_class, y = f_obs), color= \"black\", size = 2) + -->\n<!--   scale_x_log10() + scale_y_log10() + -->\n<!--   labs(caption = \"Black = observed fractions, red/purple is predicted fractions if normally/log-normally distributed and all species have the same coeff. of variation.\") + -->\n<!--   facet_wrap( ~ spp_id, ncol = 5) + -->\n<!--   labs(x = \"Size class (cm)\", y = \"Probability\") + -->\n<!--   theme_bw() -->\n<!-- ``` -->\n\n<!-- ```{r} -->\n<!-- ll_ln <- rstan::extract(fit_ln, pars = c(\"lp__\")) -->\n<!-- mean(ll_ln$lp__) # log-likelihood of log-normal assumption -->\n<!-- ``` -->\n\n<!-- ```{r} -->\n<!-- ll_n <- rstan::extract(fit_n, pars = c(\"lp__\")) -->\n<!-- mean(ll_n$lp__) # log-likelihood of normal assumption -->\n<!-- ``` -->\n",
    "supporting": [
      "simple_system_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}